/*!
 * THE IDOLM@STER CINDERELLA GIRLS Exertion Value Calculator for Idol Live Royal 
 * Copyright (c) 2013 Mutsuki Kimuraya (http://www4018uf.sakura.ne.jp/)
 * Released under the MIT license
 * http://opensource.org/licenses/mit-license.php
 */
var Common=function(){function a(){}return a.load_idol_list=function(a,b,c){void 0===c&&(c=[]);var d=this.IDOL_LIST_KEY_BASE;-1==a&&-1==b?d+="_all":(-1!=a&&(d+="_t"+a),-1!=b&&(d+="_r"+b));var e=this.cache_data[d],f=this,g=jQuery.Deferred();if(null!=e)g.resolve(JSON.parse(e));else{var h={};-1!=a&&(h.type=a),-1!=b&&(h.rarity=b),c.length>0&&(h.fields=c.join(" ")),jQuery.post(this.IDOL_DATA_API_URL,h,function(a){f.cache_data[d]=JSON.stringify(a),g.resolve(a)},"json")}return g.promise()},a.load_skill_list=function(){var a=this.SKILL_LIST_KEY,b=this.cache_data[a],c=this,d=jQuery.Deferred();return null!=b?d.resolve(JSON.parse(b)):jQuery.post(this.SKILL_DATA_API_URL,function(b){c.cache_data[a]=JSON.stringify(b),d.resolve(b)},"json"),d.promise()},a.get_compress_data=function(a){for(var b=[],c=0;c<a.length;c++){var d=a.charCodeAt(c),e=parseInt(d.toString(),10);b.push(e)}for(var f=new Zlib.Deflate(b).compress(),g="",c=0;c<f.length;c++)g+=("0"+f[c].toString(16)).slice(-2);return g},a.get_decompress_data=function(a){for(var b=[],c=0;c<a.length;c+=2)b.push(parseInt(a.substr(c,2),16));for(var d=new Zlib.Inflate(b).decompress(),e="",c=0;c<d.length;c++)e+=String.fromCharCode(d[c]);return e},a.get_param_list=function(){var a={},b=location.href.indexOf("?");if(b>-1)for(var c=location.href.slice(b+1),d=c.split("&"),e=0;e<d.length;e++){var f=d[e].split("=");f[1]&&(a[f[0]]=f[1])}return a},a.get_page_url=function(){var a=location.href,b=a.indexOf("?");return b>-1&&(a=a.slice(0,b-1)),a},a.get_qrcode_url=function(a,b){void 0===b&&(b=150);var c=[];return c.push("chs="+b+"x"+b),c.push("cht=qr"),c.push("chl="+a),this.GOOGLE_CHART_API_URL+"?"+c.join("&")},a.to_int=function(a){return a.match(/^[-+]?[0-9]+$/)||(a="0"),parseInt(a,10)},a.is_smartphone=function(){return null!=navigator.userAgent.match(/(Android|iPhone|iPad|Mobile)/g)},a.IDOL_DATA_API_URL="http://www4018uf.sakura.ne.jp/imas_cg/api/idol/list/",a.IDOL_LIST_KEY_BASE="imas_cg_idol_list",a.SKILL_DATA_API_URL="http://www4018uf.sakura.ne.jp/imas_cg/api/skill/list/",a.SKILL_LIST_KEY="imas_cg_skill_list",a.GOOGLE_CHART_API_URL="http://chart.apis.google.com/chart",a.cache_data={},a}(),UserIdol=function(){function a(a){this.TRAINER_COST=999,this.PRODUCER_TYPE_COEFFICIENT=.05,this.INSTITUTION_COEFFICIENT=.05,this.BACK_MEMBER_COEFFICIENT=.8,this.COMPATIBILITY_BONUS_COEFFICIENT=.2,this.LIVE_TOUR_NORMAL_LIVE_COEFFICIENT=.5,this.LIVE_TOUR_FULL_POWER_LIVE_COEFFICIENT=2,this.DREAM_LIVE_FESTIVAL_NORMAL_LIVE_COEFFICIENT=.5,this.DREAM_LIVE_FESTIVAL_FULL_POWER_LIVE_COEFFICIENT=2.5,this.DREAM_LIVE_FESTIVAL_COMBO_LEVEL_COEFFICIENT=125,this.TALK_BATTLE_FULL_POWER_LIVE_COEFFICIENT=5,this.TALK_BATTLE_COMBO_LEVEL_COEFFICIENT=50;var b=this;this.id=ko.observable(0),this.type=ko.observable(0),this.rarity=ko.observable(0),this.cost=ko.observable(0),this.offense=ko.observable(0),this.defense=ko.observable(0),this.event_power=ko.observable(1),this.offense_skill=ko.observable(0),this.defense_skill=ko.observable(0),this.skill_id=ko.observable(0),this.skill_level=ko.observable(10),this.skill_name=ko.observable("無し"),this.is_festival=ko.observable(!1),this.is_survival=ko.observable(!1),this.use_tour_skill=ko.observable(a),this.enable_skill=ko.observable(!1),this.actual_offense=ko.observable(0),this.actual_defense=ko.observable(0),this.display_offense=ko.computed(function(){return Math.ceil(b.actual_offense())}),this.display_defense=ko.computed(function(){return Math.ceil(b.actual_defense())}),this.style=ko.observable("numeric"),this.offense_per_cost=ko.computed(function(){return b.calc_cost_ratio(b.offense())}),this.defense_per_cost=ko.computed(function(){return b.calc_cost_ratio(b.defense())}),this.status_per_cost=ko.computed(function(){return b.calc_cost_ratio(b.status())}),this.idol_data_list=ko.observableArray(),this.select_idol_list=ko.computed(function(){return b.idol_data_list()}),this.skill_data_list=ko.observableArray(),this.select_skill_list=ko.computed(function(){return b.skill_data_list()}),this.set_idol_list(),this.set_skill_list()}return a.prototype.status=function(){return parseInt(this.offense())+parseInt(this.defense())},a.prototype.get_cost=function(){var a=parseInt(this.cost());return this.is_festival()&&a==this.TRAINER_COST&&(a=5),a},a.prototype.calc_cost_ratio=function(a){var b=parseInt(this.cost()),c=0;return b>0&&(c=Math.round(a/b*100)/100),c},a.prototype.get_cost_corrected_status=function(a,b,c){if(b>c){var d=c/b;d=Math.ceil(10*d)/10,a=Math.ceil(a*d)}return a},a.prototype.set_idol_list=function(){var a=this,b=jQuery.Deferred(),c=a.type(),d=a.rarity();return jQuery.when(a.load_idol_list(c,d)).done(function(c){a.set_select_idol_list(c),a.id(0),a.cost(0),a.offense(0),a.defense(0),a.offense_skill(0),a.defense_skill(0),a.skill_level(10),a.set_skill_info(null),b.resolve()}),b.promise()},a.prototype.set_select_idol_list=function(a){var b=[];b.push({id:0,name:"-"});for(var c in a)if(a.hasOwnProperty(c)){var d=a[c];b.push({id:d.idol_id,name:d.name})}this.idol_data_list(b)},a.prototype.set_skill_list=function(){var a=this,b=jQuery.Deferred();return jQuery.when(Common.load_skill_list()).done(function(c){var d=[];d.push({id:0,name:"-"});for(var e in c)if(c.hasOwnProperty(e)){var f=c[e];d.push({id:f.skill_id,name:f.comment})}a.skill_data_list(d),b.resolve()}),b.promise()},a.prototype.change_idol=function(){var a=this,b=parseInt(a.type()),c=parseInt(a.rarity()),d=parseInt(a.id());a.offense_skill(0),a.defense_skill(0),0!=d?jQuery.when(a.load_idol_list(b,c)).done(function(b){var c=b[d];a.cost(c.cost),a.offense(c.max_offense),a.defense(c.max_defense),a.set_skill_info(c)}):(a.cost(0),a.offense(0),a.defense(0),a.set_skill_info(null))},a.prototype.set_skill_info=function(a){var b=0,c="無し";null!=a&&(b=parseInt(a.skill_id),this.use_tour_skill()&&(b=parseInt(a.live_tour_skill_id)),void 0!=a.skill_name&&""!=a.skill_name&&(c=a.skill_name)),this.skill_name(c),this.skill_id(b)},a.prototype.get_setting=function(){var a={};return a.type=this.type(),a.rarity=this.rarity(),a.id=this.id(),a.cost=this.cost(),a.offense=this.offense(),a.defense=this.defense(),a.event_power=this.event_power(),a.offense_skill=this.offense_skill(),a.defense_skill=this.defense_skill(),a.skill_id=this.skill_id(),a.skill_level=this.skill_level(),a},a.prototype.set_setting=function(a){var b=this;b.type(a.type),b.rarity(a.rarity),jQuery.when(b.load_idol_list(parseInt(a.type),parseInt(a.rarity))).done(function(c){b.set_select_idol_list(c),b.id(a.id),null!=a.cost&&b.cost(a.cost),b.offense(a.offense),b.defense(a.defense),b.event_power(a.event_power),b.offense_skill(a.offense_skill),b.defense_skill(a.defense_skill),b.set_skill_setting(c[a.id],a.skill_id,a.skill_level)})},a.prototype.set_skill_setting=function(a,b,c){this.set_skill_info(a),this.skill_level(c);var d=this;jQuery.when(Common.load_skill_list()).done(function(a){a.hasOwnProperty(b)&&d.skill_id(b)})},a.prototype.get_type_ratio=function(a,b){var c=parseInt(this.type()),d=0;return d+=c==a?this.PRODUCER_TYPE_COEFFICIENT:parseInt(b[c])/100},a.prototype.load_idol_list=function(a,b){var c=["type","rarity","name","cost","max_offense","max_defense","skill_name","skill_id","live_tour_skill_id"],d=jQuery.Deferred();return jQuery.when(Common.load_idol_list(a,b,c)).done(function(a){d.resolve(a)}),d.promise()},a.prototype.calculation=function(a,b,c,d,e,f,g,h,i){var j=0,k=0;if(!a||b>=1){var l=parseInt(this.offense()),m=parseInt(this.defense()),n=parseFloat(this.offense_skill()),o=parseFloat(this.defense_skill());c?(j=this.calc_front_status(l,n,a,b,d,e,f,g,h,i),k=this.calc_front_status(m,o,a,b,d,e,f,g,h,i)):(j=this.calc_back_status(l,n,a,b),k=this.calc_back_status(m,o,a,b))}this.actual_offense(j),this.actual_defense(k)},a.prototype.calculation_festivalS=function(a,b,c,d,e,f,g,h,i,j){var k=parseInt(this.offense()),l=parseInt(this.defense()),m=parseFloat(this.offense_skill()),n=parseFloat(this.defense_skill()),o=0,p=0;c?(o=this.calc_festivalS_front_status(k,m,a,b,d,e,f,g,h,i,j),p=this.calc_festivalS_front_status(l,n,a,b,d,e,f,g,h,i,-1)):(o=this.calc_back_status(k,m,a,b),p=this.calc_back_status(l,n,a,b)),this.actual_offense(o),this.actual_defense(p)},a.prototype.calc_front_status=function(a,b,c,d,e,f,g,h,i,j){c&&(a=this.get_cost_corrected_status(a,this.get_cost(),d));for(var k=parseInt(this.type()),l=0;l<g.length;l++)if(k==g[l]){a=Math.ceil(a*(1+this.INSTITUTION_COEFFICIENT));break}var m=1+this.get_type_ratio(e,f)+(h+b)/100;return this.is_festival()&&(m+=i/100,j&&(m+=.1)),a=Math.ceil(a*m)},a.prototype.calc_back_status=function(a,b,c,d){var e=this.get_cost(),f=Math.ceil(a*this.BACK_MEMBER_COEFFICIENT),g=f;if(c&&(g=this.get_cost_corrected_status(g,e,d)),!this.is_festival()||!c||d>=e){var h=b/100;g=Math.floor(g)+Math.ceil(f*h*10)/10}return g},a.prototype.calc_festivalS_front_status=function(a,b,c,d,e,f,g,h,i,j,k){c&&(a=this.get_cost_corrected_status(a,this.get_cost(),d));for(var l=parseInt(this.type()),m=0;m<g.length;m++)if(l==g[m]){a=Math.ceil(a*(1+this.INSTITUTION_COEFFICIENT));break}var n=1+this.get_type_ratio(e,f)+(b+i)/100;return a=Math.ceil(a*n),n=1+h/100,a*=n,n=1,l==k&&(n+=.2),a=Math.round(a*n),n=1,j&&(n+=.1),a=Math.round(a*n)},a.prototype.calculation_survival=function(a,b){this.is_survival(!0);var c=Math.floor(parseInt(this.offense())*parseFloat(this.event_power()));a&&(c=this.get_cost_corrected_status(c,this.get_cost(),b)),this.actual_offense(c)},a.prototype.calculation_live_tour=function(a,b,c,d,e,f,g){var h=parseInt(this.offense()),i=parseInt(this.defense()),j=parseFloat(this.offense_skill()),k=parseFloat(this.defense_skill()),l=0,m=0;a?(l=this.calc_live_tour_front_status(h,j,b,c,d,e,f,g),m=this.calc_live_tour_front_status(i,k,b,c,d,e,f,g)):(l=this.calc_live_tour_back_status(h,j,d),m=this.calc_live_tour_back_status(i,k,d)),this.actual_offense(l),this.actual_defense(m)},a.prototype.calc_live_tour_status=function(a,b,c,d,e,f){var g=Math.floor(a*parseFloat(this.event_power())),h=1+this.get_type_ratio(c,d)+b/100;return g=Math.ceil(g*h),h=1,h+=e/100,g=Math.ceil(g*h),h=1,parseInt(this.type())==f&&(h+=this.COMPATIBILITY_BONUS_COEFFICIENT),g*=h},a.prototype.calc_live_tour_front_status=function(a,b,c,d,e,f,g,h){var i=Math.floor(a*parseFloat(this.event_power())),j=1+this.get_type_ratio(c,d)+(b+h)/100;return i=Math.ceil(i*j),j=1+e/100,i=Math.ceil(i*j),j=1+f/100,i=Math.ceil(i*j),j=1,parseInt(this.type())==g&&(j+=this.COMPATIBILITY_BONUS_COEFFICIENT),i*=j},a.prototype.calc_live_tour_back_status=function(a,b,c){var d=Math.floor(a*parseFloat(this.event_power()));d=Math.ceil(d*this.BACK_MEMBER_COEFFICIENT);var e=1+(b+c)/100;return d=Math.ceil(d*e)},a.prototype.calc_live_tour_damage=function(a){var b=Math.floor(this.actual_offense());return b*=a?this.LIVE_TOUR_FULL_POWER_LIVE_COEFFICIENT:this.LIVE_TOUR_NORMAL_LIVE_COEFFICIENT,b/=5},a.prototype.calculation_dream_live_festival=function(a,b,c,d,e,f){var g=parseInt(this.offense()),h=parseInt(this.defense()),i=parseFloat(this.offense_skill()),j=parseFloat(this.defense_skill()),k=0,l=0;a?(k=this.calc_dream_live_festival_front_status(g,i,b,c,d,e,f),l=this.calc_dream_live_festival_front_status(h,j,b,c,d,e,f)):(k=this.calc_dream_live_festival_back_status(g,i,e),l=this.calc_dream_live_festival_back_status(h,j,e)),this.actual_offense(k),this.actual_defense(l)},a.prototype.calc_dream_live_festival_front_status=function(a,b,c,d,e,f,g){var h=Math.floor(a*parseFloat(this.event_power())),i=1+f/100;return h=Math.floor(h*i),i=1+this.get_type_ratio(c,d)+(b+g)/100,h=Math.ceil(h*i),i=1,i+=Math.sqrt(this.DREAM_LIVE_FESTIVAL_COMBO_LEVEL_COEFFICIENT*e)/100,h=Math.ceil(h*i)},a.prototype.calc_dream_live_festival_back_status=function(a,b,c){var d=Math.floor(a*parseFloat(this.event_power()));d=Math.ceil(d*this.BACK_MEMBER_COEFFICIENT);var e=1+c/100;return d=Math.floor(d*e),e=1+b/100,d=Math.ceil(d*e)},a.prototype.calc_dream_live_festival_damage=function(a){var b=Math.floor(this.actual_offense());return b*=a?this.DREAM_LIVE_FESTIVAL_FULL_POWER_LIVE_COEFFICIENT:this.DREAM_LIVE_FESTIVAL_NORMAL_LIVE_COEFFICIENT,b/=5},a.prototype.calculation_live_royal=function(a,b,c,d,e,f,g){var h=parseInt(this.offense()),i=parseInt(this.defense()),j=parseFloat(this.offense_skill()),k=parseFloat(this.defense_skill()),l=0,m=0;a?(l=this.calc_live_royal_front_status(h,j,b,c,d,e,f,g),m=this.calc_live_royal_front_status(i,k,b,c,d,e,f,g)):(l=this.calc_live_royal_back_status(h,j,b,e,f),m=this.calc_live_royal_back_status(i,k,b,e,f)),this.actual_offense(l),this.actual_defense(m)},a.prototype.calc_live_royal_front_status=function(a,b,c,d,e,f,g,h){var i=1;c&&(i=parseFloat(this.event_power()));var j=Math.ceil(a*i);j*=f,j*=g;var k=1+this.get_type_ratio(d,e)+(b+h)/100;return j*=k,j=Math.round(10*j)/10,Math.ceil(j)},a.prototype.calc_live_royal_back_status=function(a,b,c,d,e){var f=1;c&&(f=parseFloat(this.event_power()));var g=Math.ceil(a*f);g=Math.ceil(g*this.BACK_MEMBER_COEFFICIENT),g*=d,g*=e;var h=1+b/100;return g*=h,g=Math.round(10*g)/10,Math.ceil(g)},a.prototype.calc_live_royal_damage=function(){return Math.floor(this.actual_offense())/5},a.prototype.calculation_live_trial=function(a,b,c,d){var e=parseInt(this.offense()),f=parseInt(this.defense()),g=parseFloat(this.offense_skill()),h=parseFloat(this.defense_skill()),i=0,j=0;c?(i=this.calc_live_trial_front_status(e,g,a,b,d),j=this.calc_live_trial_front_status(f,h,a,b,d)):(i=this.calc_live_trial_back_status(e,g,a,b),j=this.calc_live_trial_back_status(f,h,a,b)),this.actual_offense(i),this.actual_defense(j)},a.prototype.calc_live_trial_front_status=function(a,b,c,d,e){var f=this.get_cost();c&&(a=this.get_cost_corrected_status(a,f,d));var g=1;return parseInt(this.type())==e&&(g+=this.PRODUCER_TYPE_COEFFICIENT),g+=b/100,a=Math.ceil(a*g)},a.prototype.calc_live_trial_back_status=function(a,b,c,d){var e=this.get_cost(),f=Math.floor(a*this.BACK_MEMBER_COEFFICIENT),g=f;if(c&&(g=this.get_cost_corrected_status(g,e,d),e>d&&(g*=this.BACK_MEMBER_COEFFICIENT)),!c||d>=e){var h=b/100;g=Math.floor(g)+Math.ceil(f*h*10)/10}return Math.floor(g)},a.prototype.calculation_talk_battle=function(a,b,c,d,e,f){var g=parseInt(this.offense()),h=parseInt(this.defense()),i=parseFloat(this.offense_skill()),j=parseFloat(this.defense_skill()),k=0,l=0;a?(k=this.calc_talk_battle_front_status(g,i,b,c,d,e,f),l=this.calc_talk_battle_front_status(h,j,b,c,d,e,f)):(k=this.calc_talk_battle_back_status(g,i,d,e),l=this.calc_talk_battle_back_status(h,j,d,e)),this.actual_offense(k),this.actual_defense(l)},a.prototype.calc_talk_battle_front_status=function(a,b,c,d,e,f,g){var h=Math.floor(a*parseFloat(this.event_power())),i=1+this.get_type_ratio(c,d);return h=Math.ceil(h*i),i=1+b/100,h=Math.round(h*i),i=1+g/100,h=Math.round(h*i),i=1+Math.sqrt(this.TALK_BATTLE_COMBO_LEVEL_COEFFICIENT*e)/100,h=Math.round(h*i),i=1+f/100,h=Math.ceil(h*i)},a.prototype.calc_talk_battle_back_status=function(a,b,c,d){var e=Math.floor(a*parseFloat(this.event_power()));e=Math.ceil(e*this.BACK_MEMBER_COEFFICIENT);var f=1+b/100;return e=Math.round(e*f),f=1+Math.sqrt(this.TALK_BATTLE_COMBO_LEVEL_COEFFICIENT*c)/100,e=Math.round(e*f),f=1+d/100,e=Math.ceil(e*f)},a.prototype.calc_talk_battle_damage=function(a){var b=Math.floor(this.actual_offense());return a&&(b*=this.TALK_BATTLE_FULL_POWER_LIVE_COEFFICIENT),b/=5},a.prototype.calculation_challenge=function(a,b,c,d,e,f){var g=parseInt(this.offense()),h=parseInt(this.defense()),i=parseFloat(this.offense_skill()),j=parseFloat(this.defense_skill()),k=0,l=0;a?(k=this.calc_challenge_front_status(g,i,b,c,d,e,f),l=this.calc_challenge_front_status(h,j,b,c,d,e,f)):(k=this.calc_challenge_back_status(g,i,d),l=this.calc_challenge_back_status(h,j,d)),this.actual_offense(k),this.actual_defense(l)},a.prototype.calc_challenge_front_status=function(a,b,c,d,e,f,g){var h=parseFloat(this.event_power());parseInt(this.type())==e&&(h*=2);var i=Math.floor(a*h);return h=1+f/100,i=Math.floor(i*h),h=1+this.get_type_ratio(c,d),i=Math.ceil(i*h),h=1+b/100,i=Math.round(i*h),h=1+g/100,i=Math.round(i*h)},a.prototype.calc_challenge_back_status=function(a,b,c){var d=parseFloat(this.event_power());parseInt(this.type())==c&&(d*=2);var e=Math.floor(a*d);return e=Math.ceil(e*this.BACK_MEMBER_COEFFICIENT),d=1+b/100,e=Math.round(e*d)},a.prototype.calc_challenge_damage=function(){return Math.floor(this.actual_offense())/5},a}(),CALCULATION_TYPE;!function(a){a[a.NORMAL=0]="NORMAL",a[a.SURVIVAL=1]="SURVIVAL",a[a.FESTIVAL=2]="FESTIVAL",a[a.LIVE_TOUR=3]="LIVE_TOUR",a[a.SESSION=4]="SESSION",a[a.DREAM_LIVE_FESTIVAL=5]="DREAM_LIVE_FESTIVAL",a[a.ROYAL=6]="ROYAL",a[a.ROYAL_GUEST=7]="ROYAL_GUEST",a[a.TALK_BATTLE=8]="TALK_BATTLE",a[a.CHALLENGE=9]="CHALLENGE",a[a.FESTIVAL_S=10]="FESTIVAL_S"}(CALCULATION_TYPE||(CALCULATION_TYPE={}));var SKILL_TARGET_UNIT;!function(a){a[a.OWN=0]="OWN",a[a.RIVAL=1]="RIVAL"}(SKILL_TARGET_UNIT||(SKILL_TARGET_UNIT={}));var SKILL_TARGET_MEMBER;!function(a){a[a.SELF=0]="SELF",a[a.FRONT=1]="FRONT",a[a.BACK=2]="BACK",a[a.ALL=3]="ALL"}(SKILL_TARGET_MEMBER||(SKILL_TARGET_MEMBER={}));var SKILL_TARGET_TYPE;!function(a){a[a.CUTE=1]="CUTE",a[a.COOL=2]="COOL",a[a.PASSION=4]="PASSION",a[a.ALL=7]="ALL"}(SKILL_TARGET_TYPE||(SKILL_TARGET_TYPE={}));var SKILL_TARGET_PARAM;!function(a){a[a.ALL=0]="ALL",a[a.OFFENSE=1]="OFFENSE",a[a.DEFENSE=2]="DEFENSE"}(SKILL_TARGET_PARAM||(SKILL_TARGET_PARAM={}));var SKILL_INPUT_MODE;!function(a){a[a.MANUAL=0]="MANUAL",a[a.AUTO=1]="AUTO",a[a.AUTO_MEAN=2]="AUTO_MEAN"}(SKILL_INPUT_MODE||(SKILL_INPUT_MODE={}));var ENABLE_SKILL_TYPE;!function(a){a[a.ALL=0]="ALL",a[a.OFFENSE=1]="OFFENSE",a[a.DEFENSE=2]="DEFENSE"}(ENABLE_SKILL_TYPE||(ENABLE_SKILL_TYPE={}));var BaseLiveCalcViewModel=function(){function a(){this.SAVE_DATA_KEY="",this.MAX_INVOKE_SKILL_NUM=0,this.SKILL_INVOCATION_RATE_LIST=[];var a=this;this.calc_type=ko.observable(0),this.front_num=ko.observable(0),this.producer_type=ko.observable(-1),this.appeal_bonus=ko.observableArray([0,0,0]),this.training_room_level=ko.observable(0),this.idol_list=ko.observableArray(),this.skill_input_type=ko.observable(0),this.enable_skill_type=ko.observable(0),this.rival_front_num=ko.observableArray([0,0,0]),this.rival_back_num=ko.observableArray([0,0,0]),this.actual_status=ko.computed(function(){return[0,0]}),this.save_data_id=ko.observable(1),this.save_data_title=ko.observable(""),this.code=ko.observable(""),this.apply_code_url=ko.observable(""),this.move_up=function(){var b=a.idol_list.indexOf(this);b>0&&a.idol_list.splice(b-1,2,a.idol_list()[b],a.idol_list()[b-1])},this.move_down=function(){var b=a.idol_list.indexOf(this);b<a.idol_list().length-1&&a.idol_list.splice(b,2,a.idol_list()[b+1],a.idol_list()[b])}}return a.prototype.change_appeal_bonus=function(){this.appeal_bonus.valueHasMutated()},a.prototype.change_rival_front_num=function(){this.rival_front_num.valueHasMutated()},a.prototype.change_rival_back_num=function(){this.rival_back_num.valueHasMutated()},a.prototype.init_list=function(){this.init_idol_list();var a=Common.get_param_list();a.code&&(this.code(a.code),this.apply_code())},a.prototype.init_idol_list=function(){},a.prototype.get_setting=function(){return{}},a.prototype.set_setting=function(){},a.prototype.get_idol_setting=function(){for(var a=[],b=0;b<this.idol_list().length;b++)a.push(this.idol_list()[b].get_setting());return a},a.prototype.set_idol_setting=function(a,b,c){for(var d=jQuery.Deferred(),e={},f=0;f<a.length;f++){var g="t"+a[f].type+"_r"+a[f].rarity;g in e||(e[g]={type:a[f].type,rarity:a[f].rarity})}for(var h=Object.keys(e),i=[],f=0;f<h.length;f++){var j=e[h[f]];i.push(Common.load_idol_list(parseInt(j.type),parseInt(j.rarity)))}var k=this;return jQuery.when.apply(null,i).done(function(){for(var e=[],f=0;f<a.length&&f!=b;f++){var g=new UserIdol(c);g.set_setting(a[f]),e.push(g)}k.idol_list(e),d.resolve()}),d.promise()},a.prototype.get_appeal_bonus_setting=function(){for(var a=[],b=0;b<this.appeal_bonus().length;b++){var c={};c.type=b.toString(),c.value=this.appeal_bonus()[b],a.push(c)}return a},a.prototype.set_appeal_bonus_setting=function(a){if(void 0!=a){for(var b=this.appeal_bonus(),c=0;c<a.length;c++)if(void 0!=a[c]){var d=a[c];b[d.type]=d.value}this.appeal_bonus(b)}},a.prototype.get_rival_member_setting=function(){var a={};a.front=[];for(var b=0;b<this.rival_front_num().length;b++){var c={};c.type=b.toString(),c.value=this.rival_front_num()[b],a.front.push(c)}a.back=[];for(var b=0;b<this.rival_back_num().length;b++){var c={};c.type=b.toString(),c.value=this.rival_back_num()[b],a.back.push(c)}return a},a.prototype.set_rival_member_setting=function(a){if(void 0!=a){if(void 0!=a.front){for(var b=this.rival_front_num(),c=0;c<a.front.length;c++)if(void 0!=a.front[c]){var d=a.front[c];b[d.type]=d.value}this.rival_front_num(b)}if(void 0!=a.back){for(var e=this.rival_back_num(),c=0;c<a.back.length;c++)if(void 0!=a.back[c]){var d=a.back[c];b[d.type]=d.value}this.rival_back_num(e)}}},a.prototype.save_setting=function(){var a=this.save_data_id();try{var b=this.SAVE_DATA_KEY+"_title_"+a,c=this.save_data_title();localStorage.setItem(b,c);var b=this.SAVE_DATA_KEY+"_"+a,c=JSON.stringify(this.get_setting());localStorage.setItem(b,c)}catch(d){console.log(d.message),alert("データ保存時にエラーが発生しました。")}},a.prototype.load_setting=function(){var a=this.save_data_id();try{var b=this.SAVE_DATA_KEY+"_title_"+a,c=localStorage.getItem(b),b=this.SAVE_DATA_KEY+"_"+a,d=localStorage.getItem(b);if(null!=d){null==c&&(c="");var e=JSON.parse(d);this.save_data_title(c),this.set_setting(e)}else alert("データが保存されていません。")}catch(f){console.log(f.message),alert("データ読み込み時にエラーが発生しました。")}},a.prototype.generate_code=function(){var a=this.get_setting(),b=JSON.stringify(a);try{var c=Common.get_compress_data(b),d=Common.get_page_url()+"?code="+c;this.code(c),this.apply_code_url(d)}catch(e){console.log(e.message),alert("コードの生成に失敗しました。")}},a.prototype.apply_code=function(){var a=this.code();try{var b=Common.get_decompress_data(a),c=JSON.parse(b),d=Common.get_page_url()+"?code="+a;this.set_setting(c),this.apply_code_url(d)}catch(e){console.log(e.message),alert("コードの適用に失敗しました。")}},a.prototype.is_smartphone=function(){return Common.is_smartphone()},a.prototype.is_skill_input_type_manual=function(){return 0==parseInt(this.skill_input_type())},a.prototype.calc_skill_value=function(){if(!this.is_skill_input_type_manual()){for(var a=0;a<this.idol_list().length;a++){var b=this.idol_list()[a];b.offense_skill(0),b.defense_skill(0),b.enable_skill(!1)}var c=this;jQuery.when(this.get_invoke_skill_list()).done(function(a){for(var b=0;b<a.length;b++){var d=a[b],e=parseInt(d.target_member);switch(e){case 0:break;case 1:c.apply_skill_effect_front_member(d,b);break;case 2:c.apply_skill_effect_back_member(d,b);break;case 3:c.apply_skill_effect_front_member(d,b),c.apply_skill_effect_back_member(d,b)}}})}},a.prototype.get_invoke_skill_list=function(){for(var a=parseInt(this.front_num()),b=[[0,0,0],[0,0,0]],c=0;c<this.idol_list().length;c++){var d=this.idol_list()[c].type();a>c?b[0][d]++:b[1][d]++}for(var e=[[0,0,0],[0,0,0]],c=0;c<this.rival_front_num().length;c++)e[0][c]=parseInt(this.rival_front_num()[c]);for(var c=0;c<this.rival_back_num().length;c++)e[1][c]=parseInt(this.rival_back_num()[c]);var f=this,g=jQuery.Deferred();return jQuery.when(Common.load_skill_list()).done(function(c){for(var d=[],h=0,i=parseInt(f.skill_input_type()),j=0;j<f.idol_list().length&&a>j;j++){var k=f.idol_list()[j];if(parseInt(k.skill_id())>0&&parseInt(k.skill_level())>0){var l=f.check_skill_enable(k,c,h,b,e);if(null!=l&&(k.enable_skill(!0),d.push(l),h++),2!=i&&h>=f.MAX_INVOKE_SKILL_NUM)break}}g.resolve(d)}),g.promise()},a.prototype.check_skill_enable=function(a,b,c,d){var e=parseInt(this.enable_skill_type()),f=!1,g=jQuery.extend(!0,{},b[a.skill_id()]);if(g.skill_level=a.skill_level(),g.skill_value_list.length>0){var h=parseInt(g.target_param),i=parseInt(g.target_unit),j=parseInt(g.target_member),k=parseInt(g.target_type);0==i?(0==e||0==h||e==h)&&(0==j?(f=!0,this.apply_skill_effect(a,g,c)):f=this.check_skill_target(j,k,d)):(0==e||(e^h)>0)&&(f=!0)}return f||(g=null),g},a.prototype.check_skill_target=function(a,b,c){var d=!1;switch(a){case 1:for(var e=0;e<c[0].length;e++)if((b&1<<e)>0&&c[0][e]>0){d=!0;break}break;case 2:for(var e=0;e<c[1].length;e++)if((b&1<<e)>0&&c[1][e]>0){d=!0;break}break;case 3:for(var e=0;e<c.length;e++)for(var f=0;f<c[e].length;f++)if((b&1<<f)>0&&c[e][f]>0){d=!0;break}}return d},a.prototype.apply_skill_effect_front_member=function(a,b){for(var c=parseInt(this.front_num()),d=0;d<this.idol_list().length&&c>d;d++)this.apply_skill_effect(this.idol_list()[d],a,b)},a.prototype.apply_skill_effect_back_member=function(a,b){var c=parseInt(a.target_num);-1==c&&(c=this.idol_list().length-parseInt(this.front_num()));for(var d=0,e=this.front_num();e<this.idol_list().length&&c>d;e++)this.apply_skill_effect(this.idol_list()[e],a,b)&&d++},a.prototype.apply_skill_effect=function(a,b,c){if(!this.check_apply_skill(a,b))return!1;var d=!1,e=parseInt(b.target_param),f=parseInt(b.skill_level),g=0;if(f>0&&(g=parseInt(b.skill_value_list[f-1])),2==parseInt(this.skill_input_type())){var h=this.SKILL_INVOCATION_RATE_LIST[c];void 0!=h&&(g*=h/100)}var i=parseFloat(a.offense_skill()),j=parseFloat(a.defense_skill());switch(e){case 0:i+=g,j+=g,d=!0;break;case 1:i+=g,d=!0;break;case 2:j+=g,d=!0}return a.offense_skill(i),a.defense_skill(j),d},a.prototype.check_apply_skill=function(a,b){var c=!1,d=parseInt(a.type()),e=parseInt(b.target_unit),f=parseInt(b.target_member),g=parseInt(b.target_type);return 0==e&&(0==f||(g&1<<d)>0)&&(c=!0),c},a}(),__extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},BaseLiveTourCalcViewModel=function(a){function b(){a.call(this),this.MAX_INVOKE_SKILL_NUM=5,this.SKILL_INVOCATION_RATE_LIST=[100,50,37.5,29.6875,24.51171875,20.880126953125,18.195724487304688,16.121602058410645,14.460162818431854,13.09043737128377],this.DAMAGE_COEFFICIENT={MIN:.97,MAX:1.02,AVG:.995},this.TOTAL_DAMAGE_COEFFICIENT=5,this.max_member_num=0,this.voltage_bonus=ko.observable(0),this.front_offense=ko.observable(0),this.front_defense=ko.observable(0),this.back_offense=ko.observable(0),this.back_defense=ko.observable(0),this.total_damage_min=ko.observable(0),this.total_damage_max=ko.observable(0),this.total_damage_avg=ko.observable(0),this.battle_damage_min=ko.observable(0),this.battle_damage_max=ko.observable(0),this.battle_damage_avg=ko.observable(0)}return __extends(b,a),b}(BaseLiveCalcViewModel),ViewModel=function(a){function b(){a.call(this),this.BATTLE_POINT_RATE_LIST=[.8,1,1.5,2,2.5],this.GUEST_BATTLE_POINT_RATE_LIST=[.5,1,1.6,2.25,3],this.SAVE_DATA_KEY="imas_cg_live_royal_calc";var b=this;this.front_num(10),this.voltage_bonus(1),this.calc_type(6),this.battle_point=ko.observable(2),this.max_member_num=20,this.actual_status=ko.computed(function(){return b.calculation()}),this.init_list()}return __extends(b,a),b.prototype.is_guest_live=function(){return 7==parseInt(this.calc_type())},b.prototype.init_idol_list=function(){for(var a=[],b=0;b<this.max_member_num;b++)a.push(new UserIdol(!1));this.idol_list(a)},b.prototype.calculation=function(){this.calc_skill_value();var a=parseInt(this.battle_point()),b=this.BATTLE_POINT_RATE_LIST[a-1];this.is_guest_live()&&(b=this.GUEST_BATTLE_POINT_RATE_LIST[a-1]);for(var c=parseInt(this.front_num()),d=parseInt(this.producer_type()),e=parseFloat(this.voltage_bonus()),f=parseInt(this.training_room_level()),g=this.is_guest_live(),h=0,i=0,j=0,k=0,l=0,m=0,n={min:0,max:0,avg:0},o=0;o<this.idol_list().length;o++){var p=this.idol_list()[o],q=c>o;p.calculation_live_royal(q,g,d,this.appeal_bonus(),e,b,f);var r=p.actual_offense(),s=p.actual_defense();if(q?(j+=r,k+=s):(l+=r,m+=s),h+=r,i+=s,g){var t=p.calc_live_royal_damage();n.min+=Math.ceil(t*this.DAMAGE_COEFFICIENT.MIN*10)/10,n.max+=Math.ceil(t*this.DAMAGE_COEFFICIENT.MAX*10)/10,n.avg+=Math.ceil(t*this.DAMAGE_COEFFICIENT.AVG*10)/10}p.style("numeric "+(q?"front":"back"))}return this.front_offense(j),this.front_defense(k),this.back_offense(l),this.back_defense(m),this.total_damage_min(Math.ceil(n.min)),this.total_damage_max(Math.ceil(n.max)),this.total_damage_avg(Math.ceil(n.avg)),this.battle_damage_min(this.total_damage_min()*this.TOTAL_DAMAGE_COEFFICIENT),this.battle_damage_max(this.total_damage_max()*this.TOTAL_DAMAGE_COEFFICIENT),this.battle_damage_avg(this.total_damage_avg()*this.TOTAL_DAMAGE_COEFFICIENT),[h,i]},b.prototype.check_skill_enable=function(a,b,c,d,e){var f=parseInt(this.enable_skill_type()),g=!1,h=jQuery.extend(!0,{},b[a.skill_id()]);if(h.skill_level=parseInt(a.skill_level()),h.skill_value_list.length>0){var i=parseInt(h.target_param),j=parseInt(h.target_unit),k=parseInt(h.target_member),l=parseInt(h.target_type);if(0==j)(0==f||0==i||f==i)&&(0==k?(g=!0,this.apply_skill_effect(a,h,c)):g=this.check_skill_target(k,l,d));else if((0==f||(f^i)>0)&&(1==k||3==k)&&(g=!0,this.is_guest_live()))if(this.check_skill_target(k,l,e)){switch(i){case 1:i=2;break;case 2:i=1}h.target_member=1,h.target_param=i}else h.skill_level=0}return g||(h=null),h},b.prototype.check_apply_skill=function(a,b){var c=!1,d=parseInt(a.type()),e=parseInt(b.target_unit),f=parseInt(b.target_member),g=parseInt(b.target_type);return 0==e?(0==f||(g&1<<d)>0)&&(c=!0):1==e&&this.is_guest_live()&&(c=!0),c},b.prototype.apply_skill_effect=function(a,b,c){if(!this.check_apply_skill(a,b))return!1;var d=!1,e=parseInt(b.target_param),f=parseInt(b.skill_level),g=0;if(f>0&&(g=parseInt(b.skill_value_list[f-1])),2==parseInt(this.skill_input_type())){var h=this.SKILL_INVOCATION_RATE_LIST[c];void 0!=h&&(g*=h/100)}var i=parseFloat(a.offense_skill()),j=parseFloat(a.defense_skill());switch(e){case 0:i+=g,j+=g,d=!0;break;case 1:i+=g,d=!0;break;case 2:j+=g,d=!0}return a.offense_skill(i),a.defense_skill(j),d},b.prototype.get_setting=function(){var a={};return a.battle_point=this.battle_point(),a.producer_type=this.producer_type(),a.appeal_bonus=this.get_appeal_bonus_setting(),a.training_room_level=this.training_room_level(),a.voltage_bonus=this.voltage_bonus(),a.calc_type=this.calc_type(),a.skill_input_type=this.skill_input_type(),a.enable_skill_type=this.enable_skill_type(),a.rival_member=this.get_rival_member_setting(),a.idol=this.get_idol_setting(),a},b.prototype.set_setting=function(a){this.battle_point(a.battle_point),this.producer_type(a.producer_type),this.set_appeal_bonus_setting(a.appeal_bonus),this.training_room_level(a.training_room_level),this.voltage_bonus(a.voltage_bonus),this.calc_type(a.calc_type),this.skill_input_type(a.skill_input_type),this.enable_skill_type(a.enable_skill_type),this.set_rival_member_setting(a.rival_member),this.set_idol_setting(a.idol,this.max_member_num,!1)},b}(BaseLiveTourCalcViewModel);jQuery(function(){ko.applyBindings(new ViewModel)});